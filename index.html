<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D အရောင်း စာရင်း</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font to the entire body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
            color: #333; /* Dark grey text */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; /* Color of the track */
            border-radius: 10px; /* Rounded corners for the track */
        }
        ::-webkit-scrollbar-thumb {
            background: #888; /* Color of the scroll thumb */
            border-radius: 10px; /* Rounded corners for the thumb */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; /* Color of the thumb on hover */
        }
        /* Styling for individual record items */
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background-color: #ffffff; /* White background */
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Subtle shadow */
            transition: transform 0.2s ease-in-out; /* Smooth transition for hover effect */
        }
        .record-item:hover {
            transform: translateY(-2px); /* Lift effect on hover */
        }
        /* Styling for modal overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent black overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure modal is on top */
        }
        /* Styling for modal content box */
        .modal-content {
            background-color: #ffffff; /* White background */
            padding: 24px;
            border-radius: 16px; /* Rounded corners */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); /* Stronger shadow */
            width: 90%; /* Responsive width */
            max-width: 400px; /* Max width for larger screens */
            max-height: 80vh; /* Max height for scrollable content */
            overflow-y: auto; /* Enable vertical scrolling if content overflows */
            display: flex;
            flex-direction: column;
            gap: 16px; /* Space between elements */
        }
        /* Styling for buttons within modals */
        .modal-content button {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        /* Styling for input fields within modals */
        .modal-content input {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
        }
        /* Styling for nickname items in admin view modal */
        .admin-nickname-item {
            padding: 10px 15px;
            background-color: #f8f8f8; /* Light background */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .admin-nickname-item:hover {
            background-color: #e0e0e0; /* Darker background on hover */
        }
        .admin-nickname-item.selected {
            background-color: #bfdbfe; /* Tailwind blue-200 for selected state */
            border: 1px solid #60a5fa; /* Tailwind blue-400 border */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Firebase SDKs -->
    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Declare global variables for Firebase instances and app state
        let app;
        let db;
        let auth;
        let userId; // Current authenticated user's ID
        let currentNickname = ''; // Currently selected nickname
        let nicknames = []; // List of nicknames for the current user
        let isAdmin = false; // Flag to check if currentNickname is 'MMH'
        let currentSelectedDate = new Date(); // The date currently being viewed
        let salesRecords = []; // Sales records for the current view
        let adminViewNickname = ''; // Stores the nickname being viewed by the admin

        // YOUR Firebase project's configuration.
        // This should be copied directly from your Firebase Console -> Project settings -> Your apps -> Web app.
        const firebaseConfig = {
          apiKey: "AIzaSyDUf0QF4GqMb6s9ODTUiX7aTHRTR0YUqcE",
          authDomain: "html-3ce83.firebaseapp.com",
          projectId: "html-3ce83",
          storageBucket: "html-3ce83.firebasestorage.app",
          messagingSenderId: "602585837585",
          appId: "1:602585837585:web:16307f3f44a881c14d81b0"
          // measurementId is removed as getAnalytics is not used
          // databaseURL is removed as it's for Realtime Database, not Firestore
        };

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig); // Initialize Firebase app with YOUR config
            db = getFirestore(app); // Get Firestore instance
            auth = getAuth(app); // Get Auth instance
            console.log("Firebase Initialized successfully.");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            // Display an error message to the user using the custom message box
            document.getElementById('message-box-content').textContent = 'Firebase စတင်မှုတွင် ပြဿနာရှိပါသည်။ သင့်ရဲ့ Firebase Config ကို မှန်ကန်စွာ ထည့်သွင်းထားခြင်း ရှိမရှိ စစ်ဆေးပါ။';
            document.getElementById('message-box').classList.remove('hidden');
        }

        // Authentication State Listener
        // This listener fires whenever the user's sign-in state changes.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                userId = user.uid;
                console.log("User signed in:", userId);
                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                await loadNicknames(); // Load nicknames for the authenticated user
                updateUI(); // Update UI elements based on auth state and nickname
            } else {
                // User is signed out, attempt to sign in anonymously
                console.log("No user signed in, attempting anonymous sign-in.");
                document.getElementById('user-id-display').textContent = `User ID: မဝင်ရသေးပါ`;
                try {
                    await signInAnonymously(auth); // Use anonymous sign-in for GitHub Pages
                } catch (error) {
                    console.error("Error during authentication:", error);
                    document.getElementById('message-box-content').textContent = `အကောင့်ဝင်ရောက်မှုတွင် ပြဿနာရှိပါသည်: ${error.message}`;
                    document.getElementById('message-box').classList.remove('hidden');
                }
            }
        });

        // Utility function to format a Date object into YYYY-MM-DD string
        function formatDate(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // Update the displayed date in the header (only for main view)
        function displayDate() {
            document.getElementById('current-date').textContent = formatDate(currentSelectedDate);
            document.getElementById('current-date-header').textContent = formatDate(currentSelectedDate);
        }

        // Change the current selected date by a number of days
        function changeDate(days) {
            currentSelectedDate.setDate(currentSelectedDate.getDate() + days);
            displayDate(); // Update date display on the main page
            // If admin view is active, reload admin sales, otherwise reload main sales
            if (document.getElementById('admin-page-view').classList.contains('flex')) {
                loadAdminSalesRecords();
            } else {
                loadSalesRecords();
            }
        }

        // Load Nicknames from Firestore for the current user
        async function loadNicknames() {
            if (!userId) {
                console.warn("User ID not available yet for loading nicknames.");
                return;
            }
            try {
                // Use simplified path for nicknames collection
                const q = collection(db, `users/${userId}/nicknames`);
                const querySnapshot = await getDocs(q);
                nicknames = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Loaded nicknames:", nicknames);
                // If no nickname is currently selected, set the first loaded one as default
                if (nicknames.length > 0 && !currentNickname) {
                    currentNickname = nicknames[0].name;
                }
                updateNicknameDisplay(); // Update the nickname display in the UI
            } catch (error) {
                console.error("Error loading nicknames:", error);
                document.getElementById('message-box-content').textContent = `Nickname များတင်ရာတွင် ပြဿနာရှိပါသည်: ${error.message}`;
                document.getElementById('message-box').classList.remove('hidden');
            }
        }

        // Event listener for the nickname button to open the modal
        document.getElementById('nickname-btn').addEventListener('click', () => {
            if (!userId) {
                document.getElementById('message-box-content').textContent = 'အကောင့်ဝင်ရောက်ရန်စောင့်ဆိုင်းနေပါသည်...';
                document.getElementById('message-box').classList.remove('hidden');
                return;
            }
            // Clear previous list and populate with current nicknames
            document.getElementById('nickname-list').innerHTML = '';
            nicknames.forEach(nick => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors ${nick.name === currentNickname ? 'bg-blue-200 border border-blue-400' : 'bg-gray-100'}`;
                div.textContent = nick.name;
                div.onclick = () => selectNickname(nick.name); // Set click handler
                document.getElementById('nickname-list').appendChild(div);
            });

            // Control visibility of add nickname input/button
            const newNicknameInput = document.getElementById('new-nickname-input');
            const addNicknameButton = document.getElementById('add-nickname-button');
            const nicknameAddSection = document.getElementById('nickname-add-section'); // New ID for the container

            if (nicknames.length > 0) {
                // If a nickname already exists, hide the add section
                nicknameAddSection.classList.add('hidden');
            } else {
                // If no nickname exists, show the add section
                nicknameAddSection.classList.remove('hidden');
            }

            document.getElementById('nickname-modal').classList.remove('hidden'); // Show the modal
        });

        // Event listener to close the nickname modal
        document.getElementById('close-nickname-modal').addEventListener('click', () => {
            document.getElementById('nickname-modal').classList.add('hidden');
        });

        // Event listener to add a new nickname
        document.getElementById('add-nickname-button').addEventListener('click', async () => {
            const newNick = document.getElementById('new-nickname-input').value.trim();
            if (newNick && userId) {
                // Check if nickname already exists (should be handled by hiding UI, but good for robustness)
                if (nicknames.length > 0) { // If a nickname already exists, prevent adding more
                    document.getElementById('message-box-content').textContent = 'Nickname တစ်ခုသာ ထည့်သွင်းနိုင်ပါသည်။';
                    document.getElementById('message-box').classList.remove('hidden');
                    return;
                }
                
                try {
                    // Use simplified path for nicknames collection
                    const docRef = await addDoc(collection(db, `users/${userId}/nicknames`), { name: newNick });
                    nicknames.push({ id: docRef.id, name: newNick }); // Add to local list
                    document.getElementById('new-nickname-input').value = ''; // Clear input
                    selectNickname(newNick); // Select the newly added nickname
                    document.getElementById('nickname-modal').classList.add('hidden'); // Close modal
                    
                    // Hide the add nickname section immediately after adding
                    document.getElementById('nickname-add-section').classList.add('hidden');
                } catch (error) {
                    console.error("Error adding nickname:", error);
                    document.getElementById('message-box-content').textContent = `Nickname ထည့်ရာတွင် ပြဿနာရှိပါသည်: ${error.message}`;
                    document.getElementById('message-box').classList.remove('hidden');
                }
            } else {
                document.getElementById('message-box-content').textContent = 'Nickname ထည့်သွင်းပါ။';
                document.getElementById('message-box').classList.remove('hidden');
            }
        });

        // Function to select a nickname
        function selectNickname(nick) {
            currentNickname = nick;
            updateNicknameDisplay(); // Update display
            document.getElementById('nickname-modal').classList.add('hidden'); // Close modal
            updateUI(); // Update UI based on selected nickname (e.g., admin view button visibility)
        }

        // Update the displayed selected nickname text
        function updateNicknameDisplay() {
            document.getElementById('selected-nickname-display').textContent = currentNickname ? `Nickname: ${currentNickname}` : 'Nickname ရွေးပါ';
        }

        // Update overall UI elements and trigger data load based on current state
        function updateUI() {
            isAdmin = (currentNickname === 'MMH'); // Check if current user is admin
            const adminButton = document.getElementById('admin-view-btn');

            if (isAdmin) {
                adminButton.classList.remove('hidden'); // Show admin button if admin
            } else {
                adminButton.classList.add('hidden'); // Hide admin button otherwise
            }

            // Always load sales records for the current view (main or admin)
            if (document.getElementById('admin-page-view').classList.contains('flex')) {
                // If admin page is active, ensure admin sales are loaded
                loadAdminSalesRecords();
            } else {
                // Otherwise, load main sales
                loadSalesRecords();
            }
            // Update main sales list header
            document.getElementById('sales-list-header').textContent = `အရောင်းစာရင်း (${formatDate(currentSelectedDate)})`;
        }

        // Unsubscribe function for real-time listener to prevent memory leaks
        let unsubscribeSalesRecords = null;
        let unsubscribeAdminSalesRecords = null;

        // Load Sales Records from Firestore for the main view
        function loadSalesRecords() {
            if (unsubscribeSalesRecords) {
                unsubscribeSalesRecords(); // Unsubscribe from previous listener
            }

            if (!userId || !currentNickname) {
                document.getElementById('sales-records-list').innerHTML = '<p class="text-center text-gray-500 mt-4">Nickname ကိုရွေးချယ်ပါ</p>';
                document.getElementById('total-bet-amount').textContent = `စုစုပေါင်း: 0 ကျပ်`;
                return;
            }

            const dateString = formatDate(currentSelectedDate);
            // Use simplified path for sales records
            const recordsCollectionRef = collection(db, `salesRecords/${currentNickname}/dates/${dateString}/entries`);

            unsubscribeSalesRecords = onSnapshot(recordsCollectionRef, (snapshot) => {
                salesRecords = [];
                let totalBetAmount = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    salesRecords.push({ id: doc.id, ...data });
                    totalBetAmount += parseFloat(data.betAmount || 0); // Sum up the stored betAmount
                });
                salesRecords.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
                displaySalesRecords(totalBetAmount, 'sales-records-list', 'total-bet-amount');
            }, (error) => {
                console.error("Error fetching sales records:", error);
                document.getElementById('message-box-content').textContent = `အရောင်းစာရင်းများတင်ရာတွင် ပြဿနာရှိပါသည်: ${error.message}`;
                document.getElementById('message-box').classList.remove('hidden');
            });
        }

        // Load Sales Records from Firestore for the admin view
        function loadAdminSalesRecords() {
            if (unsubscribeAdminSalesRecords) {
                unsubscribeAdminSalesRecords(); // Unsubscribe from previous listener
            }

            if (!userId || !adminViewNickname) {
                document.getElementById('admin-sales-records-list').innerHTML = '<p class="text-center text-gray-500 mt-4">ကြည့်ရှုရန် Nickname ကိုရွေးချယ်ပါ</p>';
                document.getElementById('admin-total-bet-amount').textContent = `စုစုပေါင်း: 0 ကျပ်`;
                document.getElementById('admin-sales-list-header').textContent = ``;
                return;
            }

            const dateString = formatDate(currentSelectedDate);
            // Use simplified path for sales records
            const recordsCollectionRef = collection(db, `salesRecords/${adminViewNickname}/dates/${dateString}/entries`);

            unsubscribeAdminSalesRecords = onSnapshot(recordsCollectionRef, (snapshot) => {
                salesRecords = []; // Reusing salesRecords array, but it's for the current view
                let totalBetAmount = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    salesRecords.push({ id: doc.id, ...data });
                    totalBetAmount += parseFloat(data.betAmount || 0); // Sum up the stored betAmount
                });
                salesRecords.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
                displaySalesRecords(totalBetAmount, 'admin-sales-records-list', 'admin-total-bet-amount');
                document.getElementById('admin-sales-list-header').textContent = `${adminViewNickname} ၏ အရောင်းစာရင်း (${formatDate(currentSelectedDate)})`;
            }, (error) => {
                console.error("Error fetching admin sales records:", error);
                document.getElementById('message-box-content').textContent = `Admin အရောင်းစာရင်းများတင်ရာတွင် ပြဿနာရှိပါသည်: ${error.message}`;
                document.getElementById('message-box').classList.remove('hidden');
            });
        }


        // Display sales records in the UI (reusable function)
        function displaySalesRecords(totalBetAmount, listElementId, totalElementId) {
            const listElement = document.getElementById(listElementId);
            listElement.innerHTML = ''; // Clear existing records

            if (salesRecords.length === 0) {
                listElement.innerHTML = '<p class="text-center text-gray-500 mt-4">ယနေ့အတွက် အရောင်းမှတ်တမ်းများ မရှိသေးပါ</p>';
            } else {
                salesRecords.forEach(record => {
                    // Display the 'displayString' which holds the original input line
                    const displayContent = record.displayString || 'N/A'; // Always use displayString
                    const div = document.createElement('div');
                    div.className = 'record-item'; // Apply styling
                    div.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-lg font-semibold text-blue-700 whitespace-pre-wrap">${displayContent}</span>
                            <span class="text-sm text-gray-600">${record.betAmount ? record.betAmount.toLocaleString() : 'N/A'} ကျပ်</span>
                        </div>
                        <button class="text-red-500 hover:text-red-700 p-2 rounded-full transition-colors" onclick="deleteRecord('${record.id}')">
                            <!-- Trash icon SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    `;
                    listElement.appendChild(div);
                });
            }
            // Update total bet amount display
            document.getElementById(totalElementId).textContent = `စုစုပေါင်း: ${totalBetAmount.toLocaleString()} ကျပ်`;
        }

        // Helper function to add a single record to Firestore
        async function addRecordToFirestore(numbers, betAmount, isReverse, nickname, date, displayString) {
            try {
                const dateString = formatDate(date);
                // Use simplified path for sales records
                await addDoc(collection(db, `salesRecords/${nickname}/dates/${dateString}/entries`), {
                    betAmount: betAmount,
                    numbers: numbers, // This stores a parsed representation (e.g., "12.13", "1_TOP", "ALL_KHWAY")
                    isReverse: isReverse, // This flag might not be strictly needed for combined entries if displayString is used
                    timestamp: new Date(),
                    displayString: displayString // Stores the original input string for exact display
                });
                return true; // Indicate success
            } catch (error) {
                console.error(`Error adding record ${displayString}:`, error);
                return false; // Indicate failure
            }
        }

        // Function to process input from the textarea (single or multiple lines)
        // This function now processes all lines in the textarea and saves them as a single record.
        async function processInputAndAddRecords() {
            // Prevent adding from admin view
            if (document.getElementById('admin-page-view').classList.contains('flex')) {
                document.getElementById('message-box-content').textContent = 'Admin View တွင် မှတ်တမ်းအသစ်ထည့်သွင်း၍ မရပါ။ ပင်မစာမျက်နှာသို့ ပြန်သွားပါ။';
                document.getElementById('message-box').classList.remove('hidden');
                return;
            }

            if (!currentNickname) {
                document.getElementById('message-box-content').textContent = 'အရောင်းမှတ်တမ်းမထည့်မီ Nickname ကိုရွေးချယ်ပါ။';
                document.getElementById('message-box').classList.remove('hidden');
                return;
            }

            const recordInput = document.getElementById('record-input');
            const fullInputValue = recordInput.value.trim(); // Get the entire content of the textarea

            if (!fullInputValue) {
                document.getElementById('message-box-content').textContent = 'ထိုးကြေးပမာဏနှင့် နံပါတ်များကို ထည့်သွင်းပါ။ (ဥပမာ: 12=200 သို့မဟုတ် 12R100)';
                document.getElementById('message-box').classList.remove('hidden');
                return;
            }

            // Show confirmation box before processing
            const confirmProcess = await showConfirmBox('မှတ်တမ်းများကို ထည့်သွင်းရန် သေချာပါသလား။');
            if (!confirmProcess) {
                return; // If user cancels, do nothing
            }

            const lines = fullInputValue.split('\n');
            let totalBetAmountForBatch = 0;
            let hasReverseInBatch = false; // True if any line in the batch is a reverse bet
            const invalidLines = []; // To store lines with format errors

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue; // Skip empty lines

                let amountForThisLine = 0;
                let isReverseForThisLine = false;
                let lineIsValid = false;

                // Regex for Direct/Reverse (single or multiple numbers separated by . or /)
                // Examples: 12=100, 12R100, 12.13.14.15R2000, 12/65=400
                // Handles optional spaces around numbers, operators.
                let match = trimmedLine.match(/^\s*(\d+(?:[./]\s*\d+)*)\s*([=R])\s*(\d+)\s*$/i);
                if (match) {
                    const numbersPart = match[1].replace(/\s/g, ''); // Remove spaces from numbers part
                    const operator = match[2];
                    const amountPerNumber = parseFloat(match[3]);
                    const individualNumbersCount = numbersPart.split(/[./]/).length;
                    isReverseForThisLine = (operator.toUpperCase() === 'R');

                    if (isNaN(amountPerNumber) || amountPerNumber <= 0) {
                        // Invalid amount, will be caught by lineIsValid check
                    } else {
                        if (isReverseForThisLine) {
                            amountForThisLine = amountPerNumber * individualNumbersCount * 2; // Each number in reverse implies two permutations
                        } else {
                            amountForThisLine = amountPerNumber * individualNumbersCount;
                        }
                        lineIsValid = true;
                    }
                }

                if (!lineIsValid) { // If not a direct/reverse bet, check other types
                    // Regex for ထိပ် (Top) bet
                    // Examples: 1ထိပ်100, 1 ထိပ် 100, 1 ထိပ်=100
                    match = trimmedLine.match(/^\s*(\d+)\s*ထိပ်\s*(?:[=R])?\s*(\d+)\s*$/i);
                    if (match) {
                        const amountPerNumber = parseFloat(match[2]);
                        if (isNaN(amountPerNumber) || amountPerNumber <= 0) {
                            // Invalid amount
                        } else {
                            amountForThisLine = amountPerNumber * 10; // 10 numbers for "ထိပ်" (0-9)
                            lineIsValid = true;
                        }
                    }
                }

                if (!lineIsValid) { // If not a direct/reverse or top bet, check bottom
                    // Regex for ပိတ် (Bottom) bet
                    // Examples: 1ပိတ်100, 1 ပိတ် 100, 1 ပိတ်=100
                    match = trimmedLine.match(/^\s*(\d+)\s*ပိတ်\s*(?:[=R])?\s*(\d+)\s*$/i);
                    if (match) {
                        const amountPerNumber = parseFloat(match[2]);
                        if (isNaN(amountPerNumber) || amountPerNumber <= 0) {
                            // Invalid amount
                        } else {
                            amountForThisLine = amountPerNumber * 10; // 10 numbers for "ပိတ်" (0-9)
                            lineIsValid = true;
                        }
                    }
                }

                if (!lineIsValid) { // If not any of the above, check 'ခွေ'
                    // Regex for ခွေ (All/Full) bet
                    // Examples: 123456789ခွေ100, ခွေ=100, ခွေ100
                    // (\d*) allows for optional digits before 'ခွေ', but we treat 'ခွေ' as all 100 numbers.
                    match = trimmedLine.match(/^\s*(\d*)\s*ခွေ\s*(?:[=R])?\s*(\d+)\s*$/i);
                    if (match) {
                        const amountPerNumber = parseFloat(match[2]);
                        if (isNaN(amountPerNumber) || amountPerNumber <= 0) {
                            // Invalid amount
                        } else {
                            amountForThisLine = amountPerNumber * 100; // 100 numbers (00-99) for "ခွေ"
                            lineIsValid = true;
                        }
                    }
                }

                // Special handling for "X ပါ YYY" and "X ပါတ် YYY"
                // Examples: 1ပါ100, 1 ပါတ် 100
                // This implies 19 numbers each at the specified amount.
                if (!lineIsValid) {
                    match = trimmedLine.match(/^\s*(\d+)\s*(?:ပါ|ပါတ်)\s*(?:[=R])?\s*(\d+)\s*$/i);
                    if (match) {
                        const amountPerNumber = parseFloat(match[2]);
                        if (isNaN(amountPerNumber) || amountPerNumber <= 0) {
                            // Invalid amount
                        } else {
                            amountForThisLine = amountPerNumber * 19; // 19 numbers for "ပါ/ပါတ်" bet
                            lineIsValid = true;
                        }
                    }
                }


                if (lineIsValid && amountForThisLine > 0) {
                    totalBetAmountForBatch += amountForThisLine;
                    if (isReverseForThisLine) { // Check if this specific line was a reverse bet
                        hasReverseInBatch = true;
                    }
                } else {
                    invalidLines.push(trimmedLine);
                }
            }

            if (invalidLines.length > 0) {
                document.getElementById('message-box-content').textContent = `အောက်ပါလိုင်းများတွင် ထည့်သွင်းမှုပုံစံ မှားယွင်းနေပါသည်။ ပြန်လည်စစ်ဆေးပါ။\n\n${invalidLines.join('\n')}`;
                document.getElementById('message-box').classList.remove('hidden');
                // Do NOT clear textarea so user can correct
                return;
            }

            if (totalBetAmountForBatch === 0) {
                document.getElementById('message-box-content').textContent = 'ထည့်သွင်းရန် မှန်ကန်သော မှတ်တမ်းများ မတွေ့ပါ။';
                document.getElementById('message-box').classList.remove('hidden');
                return;
            }

            // Now, add a single record to Firestore representing the entire batch
            // The 'numbers' field can be a placeholder as the actual numbers are in displayString
            const success = await addRecordToFirestore(
                "Batch Entry", // A generic placeholder for 'numbers' field for combined entries
                totalBetAmountForBatch,
                hasReverseInBatch, // Store if any line in the batch was a reverse bet
                currentNickname,
                currentSelectedDate,
                fullInputValue // Store the entire original input for display
            );

            let message;
            if (success) {
                message = `မှတ်တမ်းများ အောင်မြင်စွာ ထည့်သွင်းပြီးပါပြီ။ စုစုပေါင်းထိုးကြေး: ${totalBetAmountForBatch.toLocaleString()} ကျပ်။`;
                recordInput.value = ''; // Clear textarea on success
            } else {
                message = `မှတ်တမ်းထည့်သွင်းရာတွင် ပြဿနာရှိပါသည်။ ကျေးဇူးပြု၍ ပြန်လည်စစ်ဆေးပါ။`;
            }
            document.getElementById('message-box-content').textContent = message;
            document.getElementById('message-box').classList.remove('hidden');
        }

        // Function to delete a sales record
        async function deleteRecord(recordId) {
            // Determine which nickname's record to delete based on active view
            const targetNickname = document.getElementById('admin-page-view').classList.contains('flex') ? adminViewNickname : currentNickname;

            if (!targetNickname) {
                document.getElementById('message-box-content').textContent = 'မှတ်တမ်းဖျက်ရန် Nickname ကိုရွေးချယ်ပါ။';
                document.getElementById('message-box').classList.remove('hidden');
                return;
            }

            // Show confirmation box before deleting
            const confirmDelete = await showConfirmBox('မှတ်တမ်းကို ဖျက်ရန် သေချာပါသလား။');
            if (!confirmDelete) {
                return; // If user cancels, do nothing
            }

            try {
                const dateString = formatDate(currentSelectedDate);
                // Use simplified path for sales records
                await deleteDoc(doc(db, `salesRecords/${targetNickname}/dates/${dateString}/entries`, recordId));
                console.log("Record deleted successfully.");
            } catch (error) {
                console.error("Error deleting record:", error);
                document.getElementById('message-box-content').textContent = `မှတ်တမ်းဖျက်ရာတွင် ပြဿနာရှိပါသည်: ${error.message}`;
                document.getElementById('message-box').classList.remove('hidden');
            }
        }

        // Event listener for the Admin View button (to switch to admin page)
        document.getElementById('admin-view-btn').addEventListener('click', async () => {
            if (!isAdmin) return; // Ensure only admin can access this

            document.getElementById('main-app-view').classList.add('hidden');
            document.getElementById('admin-page-view').classList.remove('hidden');
            document.getElementById('admin-page-view').classList.add('flex'); // Ensure it's flex for layout

            adminViewNickname = ''; // Reset selected admin nickname when entering the page
            document.getElementById('admin-sales-list-header').textContent = ''; // Clear header
            document.getElementById('admin-sales-records-list').innerHTML = '<p class="text-center text-gray-500 mt-4">ကြည့်ရှုရန် Nickname ကိုရွေးချယ်ပါ</p>';
            document.getElementById('admin-total-bet-amount').textContent = `စုစုပေါင်း: 0 ကျပ်`;

            populateAdminNicknamesPage(); // Populate the nickname list on the admin page
        });

        // Function to populate the nickname list on the admin page
        async function populateAdminNicknamesPage() {
            document.getElementById('admin-nickname-list-page').innerHTML = ''; // Clear previous list

            try {
                const allNicknamesToShow = new Set();

                // 1. Fetch nicknames that have public sales records (from anyone)
                const salesRecordsCollectionRef = collection(db, `salesRecords`);
                const salesQuerySnapshot = await getDocs(salesRecordsCollectionRef);
                salesQuerySnapshot.forEach(doc => {
                    allNicknamesToShow.add(doc.id); // doc.id here represents a nickname
                });

                // 2. Fetch nicknames created by the current user
                const userNicknamesCollectionRef = collection(db, `users/${userId}/nicknames`);
                const userNicknamesQuerySnapshot = await getDocs(userNicknamesCollectionRef);
                userNicknamesQuerySnapshot.forEach(doc => {
                    allNicknamesToShow.add(doc.data().name); // Add the 'name' field of the nickname document
                });

                const sortedNicknames = Array.from(allNicknamesToShow).sort(); // Sort alphabetically

                if (sortedNicknames.length === 0) {
                    document.getElementById('admin-nickname-list-page').innerHTML = '<p class="text-center text-gray-500 mt-4">ကြည့်ရှုရန် Nickname မရှိသေးပါ</p>';
                } else {
                    sortedNicknames.forEach(nick => {
                        if (nick === 'MMH') return; // Don't show 'MMH' in the list to view itself
                        const div = document.createElement('div');
                        div.className = `admin-nickname-item ${nick === adminViewNickname ? 'selected' : ''}`;
                        div.textContent = nick;
                        div.onclick = () => selectAdminViewNickname(nick); // Set click handler
                        document.getElementById('admin-nickname-list-page').appendChild(div);
                    });
                }
            } catch (error) {
                console.error("Error fetching nicknames for admin view page:", error);
                document.getElementById('message-box-content').textContent = `Admin ကြည့်ရန် Nickname များတင်ရာတွင် ပြဿနာရှိပါသည်: ${error.message}`;
                document.getElementById('message-box').classList.remove('hidden');
            }
        }

        // Function to select a nickname for admin view
        function selectAdminViewNickname(nick) {
            adminViewNickname = nick; // Set the nickname to be viewed by admin
            // Update selected state in the list
            Array.from(document.querySelectorAll('#admin-nickname-list-page .admin-nickname-item')).forEach(item => {
                if (item.textContent === nick) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            loadAdminSalesRecords(); // Load records for the newly selected nickname
        }

        // Event listener to go back to the main view from admin page
        document.getElementById('back-to-main-btn').addEventListener('click', () => {
            document.getElementById('admin-page-view').classList.add('hidden');
            document.getElementById('admin-page-view').classList.remove('flex');
            document.getElementById('main-app-view').classList.remove('hidden');
            adminViewNickname = ''; // Clear admin view nickname
            updateUI(); // This will reset the header and reload records for the current user's nickname
        });

        // Custom Message Box functions (replaces alert())
        document.getElementById('close-message-box').addEventListener('click', () => {
            document.getElementById('message-box').classList.add('hidden');
        });

        // Custom Confirm Box functions (replaces confirm())
        let confirmResolve; // To store the promise resolver
        function showConfirmBox(message) {
            document.getElementById('confirm-box-content').textContent = message;
            document.getElementById('confirm-box').classList.remove('hidden');
            return new Promise(resolve => {
                confirmResolve = resolve; // Store the resolve function
            });
        }

        document.getElementById('confirm-yes-btn').addEventListener('click', () => {
            document.getElementById('confirm-box').classList.add('hidden');
            confirmResolve(true); // Resolve the promise with true (confirmed)
        });

        document.getElementById('confirm-no-btn').addEventListener('click', () => {
            document.getElementById('confirm-box').classList.add('hidden');
            confirmResolve(false); // Resolve the promise with false (cancelled)
        });


        // Initial setup when the window loads
        window.onload = () => {
            displayDate(); // Display the current date
            // Nicknames and records will be loaded after Firebase authentication state is determined
        };

        // Expose functions to the global scope so they can be called from HTML event attributes
        window.changeDate = changeDate;
        window.deleteRecord = deleteRecord;
        window.processInputAndAddRecords = processInputAndAddRecords; // Expose the new function
        window.showConfirmBox = showConfirmBox; // Make confirm box accessible from HTML
    </script>

    <!-- Main Application Container -->
    <div id="main-app-view" class="flex-1 flex flex-col p-4 pb-32 max-w-xl mx-auto w-full">
        <!-- User ID Display -->
        <div id="user-id-display" class="text-xs text-gray-500 text-right mb-2"></div>

        <!-- Header Section: Date Navigation and Nickname Button -->
        <div class="flex items-center justify-between bg-white p-4 rounded-xl shadow-md mb-4">
            <!-- Date Navigation Controls -->
            <div class="flex items-center space-x-2">
                <button onclick="changeDate(-1)" class="p-2 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors">
                    <!-- Left arrow SVG icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                </button>
                <span id="current-date" class="text-lg font-semibold text-gray-800"></span>
                <button onclick="changeDate(1)" class="p-2 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors">
                    <!-- Right arrow SVG icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                </button>
            </div>

            <!-- Nickname Selection Button -->
            <button id="nickname-btn" class="p-2 bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition-colors flex items-center space-x-1">
                <!-- User icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </button>
        </div>

        <!-- Selected Nickname Display and Admin View Button -->
        <div class="flex items-center justify-between bg-white p-4 rounded-xl shadow-md mb-4">
            <span id="selected-nickname-display" class="text-md font-medium text-gray-700">Nickname ရွေးပါ</span>
            <!-- Admin View Button (hidden by default, shown for 'MMH') -->
            <button id="admin-view-btn" class="hidden px-4 py-2 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition-colors text-sm">
                Admin View
            </button>
        </div>

        <!-- Sales Records List Section -->
        <h2 id="sales-list-header" class="text-xl font-bold text-gray-800 mb-3">အရောင်းစာရင်း (<span id="current-date-header"></span>)</h2>
        <div id="sales-records-list" class="flex-1 overflow-y-auto mb-4">
            <!-- Sales records will be dynamically loaded here by JavaScript -->
            <p class="text-center text-gray-500 mt-4">မှတ်တမ်းများတင်နေသည်...</p>
        </div>

        <!-- Total Bet Amount Display -->
        <div class="bg-white p-4 rounded-xl shadow-md text-right text-lg font-bold text-blue-800 mb-4">
            <span id="total-bet-amount">စုစုပေါင်း: 0 ကျပ်</span>
        </div>
    </div>

    <!-- Admin Page View (initially hidden) -->
    <div id="admin-page-view" class="hidden flex-1 flex-col p-4 pb-32 max-w-xl mx-auto w-full">
        <!-- Admin Page Header -->
        <div class="flex items-center justify-between bg-white p-4 rounded-xl shadow-md mb-4">
            <button id="back-to-main-btn" class="p-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors">
                <!-- Back arrow SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
            </button>
            <h2 class="text-xl font-bold text-gray-800">Admin View</h2>
            <div></div> <!-- Placeholder for spacing -->
        </div>

        <!-- Admin Nickname List -->
        <h3 class="text-lg font-bold text-gray-800 mb-3">ကြည့်ရှုရန် Nickname ရွေးပါ</h3>
        <div id="admin-nickname-list-page" class="bg-white p-4 rounded-xl shadow-md mb-4 flex-1 overflow-y-auto space-y-2">
            <!-- Nicknames will be dynamically loaded here -->
        </div>

        <!-- Admin Sales Records List Section -->
        <h2 id="admin-sales-list-header" class="text-xl font-bold text-gray-800 mb-3 mt-4"></h2>
        <div id="admin-sales-records-list" class="flex-1 overflow-y-auto mb-4">
            <!-- Sales records for selected admin nickname will be loaded here -->
            <p class="text-center text-gray-500 mt-4">Nickname ရွေးချယ်ပါ</p>
        </div>

        <!-- Admin Total Bet Amount Display -->
        <div class="bg-white p-4 rounded-xl shadow-md text-right text-lg font-bold text-blue-800 mb-4">
            <span id="admin-total-bet-amount">စုစုပေါင်း: 0 ကျပ်</span>
        </div>
    </div>

    <!-- Bet Amount Input Section (Fixed at bottom of screen) -->
    <div class="fixed bottom-0 left-0 w-full bg-white p-4 shadow-lg rounded-t-2xl">
        <div class="max-w-xl mx-auto">
            <div class="flex items-end space-x-3 mb-3"> <!-- Changed items-center to items-end for textarea alignment -->
                <textarea id="record-input" placeholder="နံပါတ်=ထိုးကြေး (ဥပမာ: 12=100 သို့မဟုတ် 12R100)&#10;12.13.14.15R2000&#10;24.25.26.27=1000&#10;1ထိပ်100&#10;ခွေ50&#10;1ပါ100" rows="4" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base resize-y"></textarea>
                <button onclick="processInputAndAddRecords()" class="p-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-colors flex-shrink-0 h-fit"> <!-- h-fit to align with textarea -->
                    <!-- Plus icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                </button>
            </div>
            <!-- Button for "1 ပါ 100" is removed as requested -->
        </div>
        <!-- Two lines of empty space below the input as requested -->
        <div class="h-8"></div>
    </div>

    <!-- Nickname Selection/Add Modal (remains a modal) -->
    <div id="nickname-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Nickname ရွေးချယ်ပါ / ထည့်ပါ</h3>
            <div id="nickname-list" class="flex-1 overflow-y-auto mb-4 space-y-2">
                <!-- Nicknames will be dynamically loaded here -->
            </div>
            <!-- New container for add nickname input and button -->
            <div id="nickname-add-section">
                <input type="text" id="new-nickname-input" placeholder="Nickname အသစ်ထည့်ပါ" class="mb-3">
                <button id="add-nickname-button" class="bg-blue-600 text-white hover:bg-blue-700">Nickname ထည့်ပါ</button>
            </div>
            <button id="close-nickname-modal" class="bg-gray-300 text-gray-800 hover:bg-gray-400">ပိတ်မည်</button>
        </div>
    </div>

    <!-- Custom Message Box (replaces alert()) -->
    <div id="message-box" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-800">သတိပေးချက်</h3>
            <p id="message-box-content" class="text-gray-700"></p>
            <button id="close-message-box" class="bg-blue-600 text-white hover:bg-blue-700">နားလည်ပါပြီ</button>
        </div>
    </div>

    <!-- Custom Confirm Box (replaces confirm()) -->
    <div id="confirm-box" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-800">အတည်ပြုရန်</h3>
            <p id="confirm-box-content" class="text-gray-700"></p>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="confirm-no-btn" class="bg-gray-300 text-gray-800 hover:bg-gray-400">မလုပ်တော့ပါ</button>
                <button id="confirm-yes-btn" class="bg-red-600 text-white hover:bg-red-700">အတည်ပြုသည်</button>
            </div>
        </div>
    </div>

</body>
</html>

